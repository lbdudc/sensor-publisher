/*% if (feature.MWM_TE_Statistics || feature.MWM_TE_ActivitiesRecord) { %*/
<template>
  <v-data-table
    :items="statisticsDataFilteredAndSorted"
    :sort-by.sync="sortBy"
    :sort-desc.sync="sortDesc"
    :items-per-page="hideFooter ? -1 : 5"
    :hide-default-footer="hideFooter"
    dense
  >
    <template v-slot:header>
      <thead>
      <tr>
        <th
          v-for="mainHeader in statisticsHeaders"
          :key="mainHeader.text"
          :colspan="mainHeader.span"
          :id="mainHeader.value"
          class="text-center"
          :style="'background-color: ' + colors[mainHeader.value]"
          @click="clickOnColumn(mainHeader.value)"
        >
          {{ mainHeader.text
          }}<v-icon v-show="sortBy === mainHeader.value && isSortable">
          {{
            sortDesc === true ? "keyboard_arrow_down" : "keyboard_arrow_up"
          }}
        </v-icon>
        </th>
      </tr>
      <tr>
        <th
          v-for="secondHeader in secondRowHeaders"
          :key="secondHeader.value"
          :colspan="secondHeader.span"
          class="text-center"
          @click="clickOnColumn(secondHeader.value)"
        >
          {{ secondHeader.text
          }}<v-icon v-show="sortBy === secondHeader.value && isSortable">
          {{
            sortDesc === true ? "keyboard_arrow_down" : "keyboard_arrow_up"
          }}</v-icon
        >
        </th>
      </tr>
      </thead>
    </template>
    <template v-slot:body="{ items }">
      <tbody>
      <tr v-for="item in items" :key="item.name">
        <td
          v-for="(data, i) in item"
          :key="i"
          :class="!i.includes('employee_name') ? 'text-right' : 'text-left'"
        >
          {{
            i.includes("distance")
              ? formatToKm(data)
              : !i.includes("employee_name")
              ? formatToDHM(data)
              : data
          }}
        </td>
      </tr>
      <tr>
        <td
          class="text-center"
          :colspan="7"
          v-if="statisticsData == null || statisticsData.length === 0"
        >
          <label>{{ $t("trajectory_exploitation.noDataAvailable") }}</label>
        </td>
      </tr>
      </tbody>
    </template>
  </v-data-table>
</template>

<script>
import { formatToDHM, formatToKm } from "@/common/conversion-utils";
import RepositoryFactory from "@/repositories/RepositoryFactory";

const TrajectoryExploitationRepository = RepositoryFactory.get(
  "TrajectoryExploitationRepository"
);

export default {
  name: "StatisticsTable",
  props: ["statisticsData", "sortable", "hideFooter"],
  data() {
    return {
      colors: {},
      sortBy: "employee_name",
      sortDesc: false,
      isSortable: this.sortable
    };
  },
  computed: {
    statisticsHeaders() {
      return [
        {
          text: this.$t("trajectory_exploitation.employee"),
          value: "employee_name",
          span: 1
        },
        {
          text: this.$t(
            "trajectory_exploitation.statistics.table.total"
          ).toUpperCase(),
          value: "total",
          span: 2
        }
      ];
    },
    secondRowHeaders() {
      return [
        {
          // Empty cells
          text: "",
          span: 1
        },
        {
          text: this.$t("trajectory_exploitation.duration"),
          value: "total",
          span: 1
        },
        {
          text: this.$t("trajectory_exploitation.distance"),
          value: "total_distance",
          span: 1
        }
      ];
    },
    statisticsDataFilteredAndSorted: function() {
      let data = [];

      // We sort the data so that they are in the same order as the columns
      this.statisticsData.forEach(item => {
        let itemObj = {};
        this.statisticsHeaders.forEach(cat => {
          itemObj[cat.value] = item.values[cat.value];
          if (cat.value !== "employee_name") {
            itemObj[cat.value + "_distance"] =
              item.values[cat.value + "_distance"];
          }
        });
        data.push(itemObj);
      });

      // Sort the table data by the specified value (by default: employee_name)
      data.sort((a, b) => {
        if (this.sortDesc) {
          return a[this.sortBy] > b[this.sortBy];
        } else {
          return a[this.sortBy] > b[this.sortBy];
        }
      });
      return data;
    }
  },
  beforeCreate() {
    TrajectoryExploitationRepository.getAllActivityCategories()
      .then(data => {
        data.forEach(c => {
          this.colors[c.label] = c.color;
          this.statisticsHeaders.push({ text: c.label, value: c.label, span: 2 });
          this.secondRowHeaders.push({
            text: this.$t("trajectory_exploitation.duration"),
            value: c.label,
            span: 1
          });
          this.secondRowHeaders.push({
            text: this.$t("trajectory_exploitation.distance"),
            value: c.label + "_distance",
            span: 1
          });
        });
        this.$emit("created");
      });
  },
  methods: {
    formatToDHM(duration) {
      if (duration != null) {
        return formatToDHM(duration, true, true);
      }
    },
    formatToKm(meters) {
      if (meters != null) {
        return formatToKm(parseFloat(meters), true);
      }
    },
    clickOnColumn(from) {
      // If the table is sortable, sort by the selected column.
      // ... Otherwise, it send a "filterMap" event to parent comp.
      if (this.sortable === true) {
        if (this.sortBy === from) {
          this.sortDesc = !this.sortDesc;
        } else {
          this.sortBy = from;
          this.sortDesc = true;
        }
      } else {
        const attributeName = from.split("_")[0];
        this.selectColumn(attributeName);
        this.$emit("filter", attributeName);
      }
    },
    selectColumn(columnName) {
      const elementHTML = document.getElementById(columnName);
      if (
        columnName == null ||
        columnName === "employee" ||
        columnName === "total"
      ) {
        return;
      }
      // Remove the border to the header of the previously selected column
      if (this.oldTarget && this.oldTarget !== elementHTML) {
        this.oldTarget.style.border = "";
      }
      // Add a border to the header of the selected column
      elementHTML.style.border =
        elementHTML.style.border === "" ? "2px solid black" : "";
      this.oldTarget = elementHTML;
    }
  }
};
</script>

<style scoped>
th {
  cursor: pointer;
}
</style>
/*% } %*/
